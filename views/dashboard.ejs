<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Mi Comercio</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>

<style>
    .nav-link {
        border-radius: .5rem;
        padding: .7rem 1rem;
    }

    .nav-link:hover {
        background: rgba(255, 255, 255, 0.1);
        transition: 0.3s;
    }

    .card {
        border-radius: 1rem;
    }

    .card-body i {
        transition: transform 0.2s ease;
    }

    .card-body:hover i {
        transform: scale(1.2);
    }

    .card-header {
        font-weight: bold;
        font-size: 1.1rem;
    }
</style>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-dark bg-success shadow px-3">
        <a class="navbar-brand fw-bold" href="#"><i class="bi bi-shop me-2"></i> Mi Comercio</a>
        <div class="d-flex">
            <a href="/logout" class="btn btn-outline-light btn-sm"><i class="bi bi-box-arrow-right"></i> Cerrar
                sesi√≥n</a>
        </div>
    </nav>

    <div class="d-flex">
        <!-- Sidebar -->
        <div class="bg-dark text-white vh-100 p-3" style="width: 250px;">
            <h5 class="mb-4">Men√∫</h5>
            <ul class="nav flex-column">
                <li class="nav-item mb-2"><a href="/dashboard" class="nav-link text-white"><i
                            class="bi bi-speedometer2 me-2"></i> Dashboard</a></li>
                <li class="nav-item mb-2"><a href="/ventas" class="nav-link text-white"><i
                            class="bi bi-cash-stack me-2"></i> Ventas</a></li>
                <li class="nav-item mb-2"><a href="/gastos" class="nav-link text-white"><i
                            class="bi bi-cart-dash me-2"></i> Gastos</a></li>
                <li class="nav-item mb-2"><a href="/categorias" class="nav-link text-white"><i
                            class="bi bi-tags me-2"></i> Categor√≠as</a></li>
                <li class="nav-item mb-2"><a href="/productos" class="nav-link text-white"><i
                            class="bi bi-box-seam me-2"></i> Productos</a></li>
                <li class="nav-item mb-2"><a href="/arqueo" class="nav-link text-white"><i
                            class="bi bi-wallet2 me-2"></i> Arqueo de Caja</a></li>
            </ul>
        </div>

        <!-- Contenido principal -->
        <div class="container-fluid p-4">
            <h2 class="mb-4">Bienvenido, Administrador üëã</h2>

            <!-- Nueva Venta -->
            <div class="card shadow border-0">
                <div class="card-header bg-success text-white"><i class="bi bi-plus-circle me-2"></i> Nueva Venta</div>
                <div class="card-body">
                    <!-- Buscador -->
                    <div class="mb-3 position-relative">
                        <label for="buscarProducto" class="form-label">Buscar producto</label>
                        <input type="text" class="form-control" id="buscarProducto"
                            placeholder="Escriba para buscar...">
                        <div id="resultadosBusqueda" class="list-group position-absolute w-100"></div>
                    </div>

                    <!-- Carrito -->
                    <table class="table table-bordered" id="tablaCarrito">
                        <thead class="table-light">
                            <tr>
                                <th>Producto</th>
                                <th>Tipo</th>
                                <th>Cantidad</th>
                                <th>Precio</th>
                                <th>Subtotal</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>

                    <div class="text-end mb-3">
                        <h4>Total: $<span id="totalVenta">0.00</span></h4>
                    </div>

                    <!-- Enviar -->
                    <form action="/ventas" method="POST" onsubmit="return prepararEnvio()">
                        <input type="hidden" name="productos" id="productosInput">
                        <button type="submit" class="btn btn-success"><i class="bi bi-check2-circle me-1"></i> Guardar
                            Venta</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const buscarInput = document.getElementById("buscarProducto");
        const resultadosDiv = document.getElementById("resultadosBusqueda");
        const tablaCarrito = document.querySelector("#tablaCarrito tbody");
        const totalVentaSpan = document.getElementById("totalVenta");
        const productosInput = document.getElementById("productosInput");

        let carrito = [];

        // Buscar en DB
        buscarInput.addEventListener("input", async () => {
            const q = buscarInput.value.trim();
            if (q.length < 2) { resultadosDiv.innerHTML = ""; return; }

            const res = await fetch(`/productos/buscar?q=${q}`);
            const productos = await res.json();

            resultadosDiv.innerHTML = productos.map(p => `
      <button type="button" class="list-group-item list-group-item-action"
        data-id="${p.id}" data-nombre="${p.nombre}" data-precio="${p.precio}" data-categoria="${p.categoria}" data-tipo_venta="${p.tipo_venta}">
        ${p.nombre} - ${p.categoria} ($${Number(p.precio).toFixed(2)})
      </button>`).join("");

            document.querySelectorAll("#resultadosBusqueda button").forEach(btn => {
                btn.addEventListener("click", () => {
                    agregarAlCarrito({
                        id: btn.dataset.id,
                        nombre: btn.dataset.nombre,
                        categoria: btn.dataset.categoria,
                        precio: parseFloat(btn.dataset.precio),
                        cantidad: 1,
                        tipo_venta: btn.dataset.tipo_venta
                    });
                    buscarInput.value = "";
                    resultadosDiv.innerHTML = "";
                });
            });
        });

        // Agregar producto
        function agregarAlCarrito(prod) {
            carrito.push(prod);
            renderCarrito();
        }

        // Renderizar carrito completo (solo se usa al agregar/eliminar productos)
        function renderCarrito() {
            tablaCarrito.innerHTML = "";
            let total = 0;

            carrito.forEach((p, index) => {
                const subtotal = p.cantidad * p.precio;
                total += subtotal;

                const fila = document.createElement("tr");
                fila.innerHTML = `
          <td>${p.nombre} - ${p.categoria}</td>
          <td><input type="text" class="form-control form-control-sm" value="${p.tipo_venta}" readonly></td>
          <td>
            <input type="text" 
                   class="form-control form-control-sm" 
                   value="${p.cantidad}" 
                   oninput="cambiarCantidad(${index}, this)">
          </td>
          <td><input type="number" class="form-control form-control-sm" value="${p.precio}" readonly></td>
          <td>$${subtotal.toFixed(3)}</td>
          <td><button type="button" class="btn btn-danger btn-sm" onclick="eliminarProducto(${index})"><i class="bi bi-trash"></i></button></td>
        `;
                tablaCarrito.appendChild(fila);
            });

            totalVentaSpan.textContent = total.toFixed(3);
        }

        // Cambiar cantidad sin perder foco
        function cambiarCantidad(index, input) {
            const cantidad = parseFloat(input.value.replace(",", ".")) || 0;
            carrito[index].cantidad = cantidad;

            // actualizar solo el subtotal de esa fila
            const fila = input.closest("tr");
            const subtotal = carrito[index].cantidad * carrito[index].precio;
            fila.querySelector("td:nth-child(5)").textContent = `$${subtotal.toFixed(3)}`;

            // recalcular total
            const total = carrito.reduce((sum, p) => sum + (p.cantidad * p.precio), 0);
            totalVentaSpan.textContent = total.toFixed(3);
        }

        function eliminarProducto(index) {
            carrito.splice(index, 1);
            renderCarrito();
        }

        function prepararEnvio() {
            if (carrito.length === 0) {
                Swal.fire("Error", "Debe agregar al menos un producto", "error");
                return false;
            }
            productosInput.value = JSON.stringify(carrito);
            return true;
        }

        // Mensaje de √©xito y abrir ticket en nueva pesta√±a
        const mensaje = "<%= mensaje ? mensaje : '' %>";
        const ticketUrl = "<%= ticketUrl ? ticketUrl : '' %>";

        if (mensaje) {
            Swal.fire({
                position: 'top-end',
                icon: 'success',
                title: mensaje,
                showConfirmButton: false,
                timer: 2000
            });

            if (ticketUrl) {
                window.open(ticketUrl, '_blank');
            }
        }

    </script>
</body>

</html>